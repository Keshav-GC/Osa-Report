<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grupo Bimbo OSA Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .searchable-multiselect-container {
            position: relative;
        }
        .searchable-multiselect-options {
            display: none; /* Hidden by default */
            position: absolute;
            background-color: white;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            width: 100%;
            z-index: 20;
            max-height: 250px;
            margin-top: 0.25rem;
            overflow-y: hidden;
            flex-direction: column;
        }
        .searchable-multiselect-options.visible {
            display: flex; /* Make visible */
        }
        .searchable-multiselect-options .search-input {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid #d1d5db;
            width: 100%;
            outline: none;
        }
        .searchable-multiselect-options .options-list {
            overflow-y: auto;
            flex-grow: 1;
        }
        .searchable-multiselect-option {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            cursor: pointer;
        }
        .searchable-multiselect-option:hover {
            background-color: #f3f4f6;
        }
        .searchable-multiselect-option input {
            margin-right: 0.75rem;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .toggle-container {
            display: flex;
            background-color: #e5e7eb;
            border-radius: 9999px;
            padding: 4px;
            width: fit-content;
        }
        .toggle-label {
            cursor: pointer;
            padding: 6px 16px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 9999px;
            transition: all 0.2s ease-in-out;
            color: #4b5563;
        }
        .toggle-radio:checked + .toggle-label {
            background-color: #ffffff;
            color: #1e40af;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="login-overlay" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center text-gray-900 mb-6">Dashboard Login</h2>
            <form id="login-form">
                <div class="space-y-4">
                    <div><label for="username" class="block text-sm font-medium text-gray-700">Account Name</label><input type="text" id="username" name="username" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" required></div>
                    <div><label for="password" class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="password" name="password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md" required></div>
                    <p id="login-error" class="text-sm text-red-600 hidden">Invalid username or password.</p>
                </div>
                <div class="mt-6"><button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">Login</button></div>
            </form>
        </div>
    </div>
    
    <div id="dashboard-content" class="hidden p-4 md:p-8">
        <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8 space-y-12">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Grupo Bimbo OSA Dashboard</h1>
                <p class="text-gray-600 mt-1">This report is automatically updated. Data is refreshed each time the page is loaded.</p>
            </div>
            
            <div>
                 <div class="flex flex-col md:flex-row justify-between items-start md:items-center border-b pb-2 mb-6">
                    <div class="flex items-center space-x-4">
                        <h2 class="text-2xl font-bold text-gray-800">Platform Summary</h2>
                        <button id="download-summary-btn" class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                             <svg class="-ml-1 mr-2 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                             Download
                        </button>
                    </div>
                     <div class="flex flex-col md:flex-row md:space-x-4 items-end mt-4 md:mt-0">
                        <div class="toggle-container">
                            <input type="radio" id="summary-calc-weighted" name="calcTypeSummary" value="weighted" class="hidden toggle-radio" checked>
                            <label for="summary-calc-weighted" class="toggle-label">Weighted OSA</label>
                            <input type="radio" id="summary-calc-normal" name="calcTypeSummary" value="normal" class="hidden toggle-radio">
                            <label for="summary-calc-normal" class="toggle-label">Normal OSA</label>
                        </div>
                        <div class="toggle-container mt-2 md:mt-0">
                            <input type="radio" id="summary-scope-all" name="scopeTypeSummary" value="all_stores" class="hidden toggle-radio">
                            <label for="summary-scope-all" class="toggle-label">All Stores</label>
                            <input type="radio" id="summary-scope-listed" name="scopeTypeSummary" value="listed_stores" class="hidden toggle-radio" checked>
                            <label for="summary-scope-listed" class="toggle-label">Listed Stores</label>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8 items-end">
                    <div id="bgr-summary-multiselect-container"></div>
                    <div id="city-summary-multiselect-container"></div>
                    <div id="timeslot-summary-multiselect-container"></div>
                </div>
                <div id="output-platform-summary" class="bg-gray-50 p-4 rounded-lg min-h-[200px] flex items-center justify-center"></div>
            </div>

            <div>
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center border-b pb-2 mb-6">
                       <div class="flex items-center space-x-4">
                           <h2 class="text-2xl font-bold text-gray-800">Detailed Breakdown</h2>
                           <button id="download-detail-btn" class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                <svg class="-ml-1 mr-2 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                Download
                            </button>
                       </div>
                        <div class="flex flex-col md:flex-row md:space-x-4 items-end mt-4 md:mt-0">
                        <div class="toggle-container">
                            <input type="radio" id="detail-calc-weighted" name="calcTypeDetail" value="weighted" class="hidden toggle-radio" checked>
                            <label for="detail-calc-weighted" class="toggle-label">Weighted OSA</label>
                            <input type="radio" id="detail-calc-normal" name="calcTypeDetail" value="normal" class="hidden toggle-radio">
                            <label for="detail-calc-normal" class="toggle-label">Normal OSA</label>
                        </div>
                        <div class="toggle-container mt-2 md:mt-0">
                            <input type="radio" id="detail-scope-all" name="scopeTypeDetail" value="all_stores" class="hidden toggle-radio">
                            <label for="detail-scope-all" class="toggle-label">All Stores</label>
                            <input type="radio" id="detail-scope-listed" name="scopeTypeDetail" value="listed_stores" class="hidden toggle-radio" checked>
                            <label for="detail-scope-listed" class="toggle-label">Listed Stores</label>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 items-end">
                    <div id="platform-multiselect-container"></div>
                    <div id="bgr-multiselect-container"></div>
                    <div id="city-multiselect-container"></div>
                    <div id="sku-multiselect-container"></div>
                </div>
                <div id="legend" class="hidden justify-end items-center space-x-4 mb-2 text-sm">
                    <span class="font-medium">Legend:</span>
                    <span class="text-red-600 font-semibold">&lt;50%</span>
                    <div class="w-24 h-4 rounded-md" style="background: linear-gradient(to right, hsl(0, 90%, 85%), hsl(60, 90%, 85%), hsl(120, 90%, 85%));"></div>
                    <span class="text-green-600 font-semibold">&gt;80%</span>
                </div>
                <div id="output-table" class="bg-gray-50 p-4 rounded-lg min-h-[300px] flex items-center justify-center">
                    <div id="initial-message" class="text-center text-gray-500">
                        <h3 class="mt-2 text-sm font-semibold text-gray-900">Waiting for Login</h3>
                        <p class="mt-1 text-sm text-gray-500">Data will load after successful login.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ELEMENT SELECTORS ---
        const loginOverlay = document.getElementById('login-overlay');
        const loginForm = document.getElementById('login-form');
        const dashboardContent = document.getElementById('dashboard-content');
        
        const bgrSummaryContainer = document.getElementById('bgr-summary-multiselect-container');
        const citySummaryContainer = document.getElementById('city-summary-multiselect-container');
        const timeslotSummaryContainer = document.getElementById('timeslot-summary-multiselect-container');
        const outputPlatformSummaryDiv = document.getElementById('output-platform-summary');
        const downloadSummaryBtn = document.getElementById('download-summary-btn');

        const platformContainer = document.getElementById('platform-multiselect-container');
        const bgrContainer = document.getElementById('bgr-multiselect-container');
        const cityContainer = document.getElementById('city-multiselect-container');
        const skuContainer = document.getElementById('sku-multiselect-container');
        const outputDiv = document.getElementById('output-table');
        const downloadDetailBtn = document.getElementById('download-detail-btn');
        
        const dataUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSs0rx52hCw6ZQRgnjNgZ6iJHKq6zZoW4-p1kgqYklsHOBOdP9ZExcYtXyZlA81Bu0XAVXfoT3xm6Wm/pub?gid=0&single=true&output=csv';

        // --- STATE VARIABLES ---
        let baseData = [], columnKeys = {};
        let activeData = [];
        let summaryTableCsvData = [], detailedTableCsvData = [];

        let selectedBgrsSummary = new Set(), selectedCitiesSummary = new Set();
        let selectedTimeslotsSummary = new Set(['10_am', '5_pm', '10_pm']);
        let selectedPlatforms = new Set(), selectedCities = new Set(), selectedBgrs = new Set(), selectedSkus = new Set();
        
        // --- INITIAL SETUP & EVENT LISTENERS ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (e.target.username.value === 'Grupobimbo' && e.target.password.value === 'Grupobimbo') {
                loginOverlay.classList.add('hidden');
                dashboardContent.classList.remove('hidden');
                loadDataFromUrl();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        });

        dashboardContent.addEventListener('change', (e) => {
            if (e.target.classList.contains('toggle-radio')) {
                const name = e.target.name; const value = e.target.value; let targetName;
                if (name.startsWith('calcType')) targetName = (name === 'calcTypeSummary') ? 'calcTypeDetail' : 'calcTypeSummary';
                else if (name.startsWith('scopeType')) targetName = (name === 'scopeTypeSummary') ? 'scopeTypeDetail' : 'scopeTypeSummary';
                
                if (targetName) {
                    const targetRadio = document.querySelector(`input[name="${targetName}"][value="${value}"]`);
                    if (targetRadio) targetRadio.checked = true;
                }
                renderPlatformSummaryTable();
                renderFinalTable();
            }
        });
        
        document.addEventListener('click', (e) => {
            const allDropdowns = document.querySelectorAll('.searchable-multiselect-container');
            let clickedInsideA_Dropdown = false;
            allDropdowns.forEach(container => { if(container.contains(e.target)) clickedInsideA_Dropdown = true; });
            if (!clickedInsideA_Dropdown) {
                document.querySelectorAll('.searchable-multiselect-options.visible').forEach(panel => panel.classList.remove('visible'));
            }
        });
        
        downloadSummaryBtn.addEventListener('click', () => downloadCsv(summaryTableCsvData, 'Platform_Summary.csv'));
        downloadDetailBtn.addEventListener('click', () => downloadCsv(detailedTableCsvData, 'Detailed_Breakdown.csv'));

        // --- DATA LOADING & PREPARATION ---
        function loadDataFromUrl() {
            showLoader(outputDiv, 'Loading data...');
            showLoader(outputPlatformSummaryDiv, '');
            Papa.parse(dataUrl, {
                download: true, header: true, skipEmptyLines: true,
                complete: (results) => {
                    const headers = results.meta.fields.map(h => h.trim().toLowerCase());
                    columnKeys = {
                        platform: headers.find(h => h === 'gc_platform'), bgr: headers.find(h => h === 'bgr'), city: headers.find(h => h === 'gc_city'),
                        sku: headers.find(h => h === 'title'), time: headers.find(h => h === 'gc_crawl_time'), date: headers.find(h => h === 'report_date'),
                        available: headers.find(h => h === 'available_stores'), listed: headers.find(h => h === 'listed_stores'), total: headers.find(h => h === 'total_stores'),
                        osaxsales: headers.find(h => h === 'osaxsales'), listed_osaxsales: headers.find(h => h === 'listed_osaxsales'), sales: headers.find(h => h === 'sales')
                    };
                    const requiredKeys = ['platform', 'bgr', 'city', 'sku', 'time', 'date', 'available', 'listed', 'total', 'osaxsales', 'listed_osaxsales', 'sales'];
                    const missingKeys = requiredKeys.filter(k => !columnKeys[k]);
                    if (missingKeys.length > 0) {
                        const errorMsg = `Data source error: Missing required columns: ${missingKeys.join(', ')}.`;
                        showError(outputDiv, errorMsg); showError(outputPlatformSummaryDiv, errorMsg); return;
                    }
                    baseData = results.data.map(row => {
                        const cleanedRow = {};
                        results.meta.fields.forEach(header => cleanedRow[header.trim().toLowerCase()] = row[header]?.trim() || '';
                        return cleanedRow;
                    });
                    initializeSummaryFilters();
                    initializeDetailFilters();
                },
                error: (err) => {
                    const errorMsg = "Could not load data. Check Google Sheet URL and sharing settings.";
                    showError(outputDiv, errorMsg); showError(outputPlatformSummaryDiv, errorMsg);
                }
            });
        }

        // --- TOGGLE STATE GETTERS ---
        function getCalcType() { return document.querySelector('input[name="calcTypeSummary"]:checked').value; }
        function getScopeType() { return document.querySelector('input[name="scopeTypeSummary"]:checked').value; }
        
        // --- SUMMARY TABLE LOGIC ---
        function initializeSummaryFilters() {
            const bgrs = new Set(baseData.map(row => row[columnKeys.bgr]));
            const cities = new Set(baseData.map(row => row[columnKeys.city]));
            const timeslots = new Set(baseData.map(row => row[columnKeys.time]));
            
            createSearchableMultiSelect(bgrSummaryContainer, 'bgr_summary', 'BGR', bgrs, selectedBgrsSummary, renderPlatformSummaryTable);
            createSearchableMultiSelect(citySummaryContainer, 'city_summary', 'City', cities, selectedCitiesSummary, renderPlatformSummaryTable);
            createSearchableMultiSelect(timeslotSummaryContainer, 'timeslot_summary', 'Time Slot', timeslots, selectedTimeslotsSummary, renderPlatformSummaryTable, true);
            renderPlatformSummaryTable();
        }

        function renderPlatformSummaryTable() {
            let summaryData = baseData;
            if (selectedBgrsSummary.size > 0) summaryData = summaryData.filter(row => selectedBgrsSummary.has(row[columnKeys.bgr]));
            if (selectedCitiesSummary.size > 0) summaryData = summaryData.filter(row => selectedCitiesSummary.has(row[columnKeys.city]));
            if (summaryData.length === 0) { showError(outputPlatformSummaryDiv, "No data for selected summary filters."); return; }
            processAndRenderPlatformPivot(summaryData, outputPlatformSummaryDiv);
        }
        
        function processAndRenderPlatformPivot(data, outputElement) {
            const pivotData = {}, dates = new Set(), platforms = new Set();
            const cleanAndParseFloat = (val) => parseFloat((typeof val === 'string' ? val.replace(/[^0-9.-]/g, '') : val));

            data.forEach(row => {
                const time = row[columnKeys.time], platform = row[columnKeys.platform], date = row[columnKeys.date];
                if (!selectedTimeslotsSummary.has(time)) return; 
                const available = cleanAndParseFloat(row[columnKeys.available]), listed = cleanAndParseFloat(row[columnKeys.listed]), total = cleanAndParseFloat(row[columnKeys.total]);
                const osaxsales = cleanAndParseFloat(row[columnKeys.osaxsales]), listed_osaxsales = cleanAndParseFloat(row[columnKeys.listed_osaxsales]), sales = cleanAndParseFloat(row[columnKeys.sales]);
                if (!time || !platform || !date || isNaN(available) || isNaN(listed) || isNaN(total) || isNaN(osaxsales) || isNaN(listed_osaxsales) || isNaN(sales)) return;
                
                platforms.add(platform); dates.add(date);
                if (!pivotData[platform]) pivotData[platform] = {};
                if (!pivotData[platform][time]) pivotData[platform][time] = {};
                if (!pivotData[platform][time][date]) {
                    pivotData[platform][time][date] = { available_sum: 0, listed_sum: 0, total_sum: 0, osaxsales_sum: 0, listed_osaxsales_sum: 0, sales_sum: 0 };
                }
                const cell = pivotData[platform][time][date];
                cell.available_sum += available; cell.listed_sum += listed; cell.total_sum += total;
                cell.osaxsales_sum += osaxsales; cell.listed_osaxsales_sum += listed_osaxsales; cell.sales_sum += sales;
            });

            const sortedPlatforms = Array.from(platforms).sort();
            const sortedTimes = Array.from(selectedTimeslotsSummary).sort((a,b) => convertTimeTo24Hour(a) - convertTimeTo24Hour(b));
            const sortedDates = Array.from(dates).sort((a, b) => parseDate(a) - parseDate(b));
            
            if (!sortedPlatforms.length || !sortedDates.length) { return showError(outputElement, "No valid data to display in summary."); }
            displayPlatformSummaryPivot(pivotData, sortedPlatforms, sortedTimes, sortedDates, outputElement, getCalcType(), getScopeType());
        }

        function displayPlatformSummaryPivot(pivotData, sortedPlatforms, sortedTimes, sortedDates, outputElement, calcType, scopeType) {
            let csvRows = [];
            const headerRow = ['Platform', 'Time Slot', ...sortedDates.map(d => d.toDateString()), 'Grand Total'];
            csvRows.push(headerRow);

            let tableHtml = `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-300">`;
            tableHtml += `<thead class="bg-gray-50"><tr><th class="sticky left-0 bg-gray-50 z-10 py-3.5 pl-4 pr-3 text-left text-sm font-semibold">Platform</th><th class="px-3 py-3.5 text-left text-sm font-semibold">Time Slot</th>`;
            sortedDates.forEach(d => tableHtml += `<th class="px-3 py-3.5 text-center text-sm font-semibold">${d.toLocaleDateString()}</th>`);
            tableHtml += `<th class="sticky right-0 bg-gray-50 z-10 py-3.5 pl-3 pr-4 text-center text-sm font-semibold">Grand Total</th></tr></thead>`;
            tableHtml += `<tbody class="bg-white">`;

            const calculateAvg = (totals) => {
                if (!totals) return 0;
                let num, den;
                if (calcType === 'weighted') {
                    num = (scopeType === 'all_stores') ? totals.osaxsales_sum : totals.listed_osaxsales_sum;
                    den = totals.sales_sum;
                } else {
                    num = totals.available_sum;
                    den = (scopeType === 'all_stores') ? totals.total_sum : totals.listed_sum;
                }
                return den > 0 ? (num / den) * 100 : 0;
            };

            if (sortedTimes.length === 0) {
                 tableHtml += `<tr><td colspan="${sortedDates.length + 3}" class="text-center py-4">Please select at least one Time Slot.</td></tr>`;
                 csvRows.push(["Please select at least one Time Slot."]);
            } else {
                sortedPlatforms.forEach((platform, index) => {
                    sortedTimes.forEach((time, timeIndex) => {
                        let rowTotals = { available_sum: 0, listed_sum: 0, total_sum: 0, osaxsales_sum: 0, listed_osaxsales_sum: 0, sales_sum: 0 };
                        let csvRow = [platform, time];
                        tableHtml += `<tr class="${index % 2 === 0 ? '' : 'bg-gray-50'}">`;
                        if (timeIndex === 0) tableHtml += `<td class="font-medium py-4 pl-4 pr-3 text-sm" rowspan="${sortedTimes.length}">${platform}</td>`;
                        tableHtml += `<td class="px-3 py-4 text-sm text-gray-500">${time}</td>`;
                        sortedDates.forEach(date => {
                            const cell = pivotData[platform]?.[time]?.[date.toLocaleDateString()];
                            if(cell) Object.keys(rowTotals).forEach(key => rowTotals[key] += cell[key]);
                            const avg = calculateAvg(cell);
                            tableHtml += `<td class="text-center py-4 px-3 text-sm" style="background-color: ${getGradientColor(avg)};">${avg.toFixed(0)}%</td>`;
                            csvRow.push(`${avg.toFixed(0)}%`);
                        });
                        const rowAvg = calculateAvg(rowTotals);
                        tableHtml += `<td class="sticky right-0 font-semibold text-center py-4 pl-3 pr-4 text-sm" style="background-color: ${getGradientColor(rowAvg)};">${rowAvg.toFixed(0)}%</td>`;
                        csvRow.push(`${rowAvg.toFixed(0)}%`);
                        tableHtml += `</tr>`;
                        csvRows.push(csvRow);
                    });
                     if (index < sortedPlatforms.length -1) tableHtml += `<tr class="border-t"></tr>`;
                });
            }
            tableHtml += `</tbody></table></div>`;
            outputElement.innerHTML = tableHtml;
            summaryTableCsvData = csvRows;
        }

        // --- DETAILED TABLE LOGIC ---
        function initializeDetailFilters() {
            const platforms = new Set(baseData.map(row => row[columnKeys.platform]));
            createSearchableMultiSelect(platformContainer, 'platform', 'Platform', platforms, selectedPlatforms, updateBgrAndCityFilters);
            updateBgrAndCityFilters();
        }

        function updateBgrAndCityFilters() {
            const platformFilteredData = baseData.filter(row => selectedPlatforms.has(row[columnKeys.platform]));
            const bgrs = new Set(platformFilteredData.map(row => row[columnKeys.bgr]));
            const cities = new Set(platformFilteredData.map(row => row[columnKeys.city]));
            createSearchableMultiSelect(bgrContainer, 'bgr', 'BGR', bgrs, selectedBgrs, updateSkuFilter);
            createSearchableMultiSelect(cityContainer, 'city', 'City', cities, selectedCities, updateSkuFilter);
            updateSkuFilter();
        }

        function updateSkuFilter() {
            const brandFilteredData = baseData.filter(row => selectedPlatforms.has(row[columnKeys.platform]) && selectedBgrs.has(row[columnKeys.bgr]) && selectedCities.has(row[columnKeys.city]));
            const skus = new Set(brandFilteredData.map(row => row[columnKeys.sku]));
            createSearchableMultiSelect(skuContainer, 'sku', 'SKU (Title)', skus, selectedSkus, renderFinalTable);
            renderFinalTable();
        }
        
        function renderFinalTable() {
            activeData = baseData.filter(row => selectedPlatforms.has(row[columnKeys.platform]) && selectedBgrs.has(row[columnKeys.bgr]) && selectedCities.has(row[columnKeys.city]) && selectedSkus.has(row[columnKeys.sku]));
            processAndRenderPivot(activeData, outputDiv);
        }

        function processAndRenderPivot(data, outputElement) {
            const legend = document.getElementById('legend');
            if (!data || !data.length) {
                legend.classList.add('hidden');
                detailedTableCsvData = [];
                return showError(outputElement, "No data for current filters.");
            }
            const pivotData = {}, dates = new Set(), crawlTimes = new Set();
            const cleanAndParseFloat = (val) => parseFloat((typeof val === 'string' ? val.replace(/[^0-9.-]/g, '') : val));

            data.forEach(row => {
                const time = row[columnKeys.time], date = row[columnKeys.date];
                const available = cleanAndParseFloat(row[columnKeys.available]), listed = cleanAndParseFloat(row[columnKeys.listed]), total = cleanAndParseFloat(row[columnKeys.total]);
                const osaxsales = cleanAndParseFloat(row[columnKeys.osaxsales]), listed_osaxsales = cleanAndParseFloat(row[columnKeys.listed_osaxsales]), sales = cleanAndParseFloat(row[columnKeys.sales]);
                if (!time || !date || isNaN(available) || isNaN(listed) || isNaN(total) || isNaN(osaxsales) || isNaN(listed_osaxsales) || isNaN(sales)) return;
                
                dates.add(date); crawlTimes.add(time);
                if (!pivotData[time]) pivotData[time] = {};
                if (!pivotData[time][date]) {
                    pivotData[time][date] = { available_sum: 0, listed_sum: 0, total_sum: 0, osaxsales_sum: 0, listed_osaxsales_sum: 0, sales_sum: 0 };
                }
                const cell = pivotData[time][date];
                cell.available_sum += available; cell.listed_sum += listed; cell.total_sum += total;
                cell.osaxsales_sum += osaxsales; cell.listed_osaxsales_sum += listed_osaxsales; cell.sales_sum += sales;
            });
            const sortedDates = Array.from(dates).sort((a, b) => parseDate(a) - parseDate(b));
            const sortedCrawlTimes = Array.from(crawlTimes).sort((a, b) => convertTimeTo24Hour(a) - convertTimeTo24Hour(b));
            
            if (!sortedDates.length || !sortedCrawlTimes.length) {
                legend.classList.add('hidden');
                detailedTableCsvData = [];
                return showError(outputElement, "No valid date/time data for pivot table.");
            }

            legend.classList.remove('hidden');
            legend.classList.add('flex');
            renderPivotTable(pivotData, sortedDates, sortedCrawlTimes, outputElement, getCalcType(), getScopeType());
        }

        function renderPivotTable(pivotData, sortedDates, sortedCrawlTimes, outputElement, calcType, scopeType) {
            let csvRows = [];
            const headerRow = ['Crawl Time', ...sortedDates, 'Grand Total'];
            csvRows.push(headerRow);

            let tableHtml = `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-300">`;
            tableHtml += `<thead class="bg-gray-50"><tr><th class="sticky left-0 bg-gray-50 z-10 py-3.5 pl-4 pr-3 text-left text-sm font-semibold">Crawl Time</th>`;
            sortedDates.forEach(date => tableHtml += `<th class="px-3 py-3.5 text-center text-sm font-semibold">${date}</th>`);
            tableHtml += `<th class="sticky right-0 bg-gray-50 z-10 py-3.5 pl-3 pr-4 text-center text-sm font-semibold">Grand Total</th></tr></thead>`;
            tableHtml += `<tbody class="divide-y divide-gray-200 bg-white">`;
            const dateTotals = {}; sortedDates.forEach(d => dateTotals[d] = { available_sum: 0, listed_sum: 0, total_sum: 0, osaxsales_sum: 0, listed_osaxsales_sum: 0, sales_sum: 0 });
            
            const calculateAvg = (totals) => {
                if (!totals) return 0;
                let numerator, denominator;
                if (calcType === 'weighted') {
                    numerator = (scopeType === 'all_stores') ? totals.osaxsales_sum : totals.listed_osaxsales_sum;
                    denominator = totals.sales_sum;
                } else {
                    numerator = totals.available_sum;
                    denominator = (scopeType === 'all_stores') ? totals.total_sum : totals.listed_sum;
                }
                return denominator > 0 ? (numerator / denominator) * 100 : 0;
            };

            sortedCrawlTimes.forEach(time => {
                let rowTotals = { available_sum: 0, listed_sum: 0, total_sum: 0, osaxsales_sum: 0, listed_osaxsales_sum: 0, sales_sum: 0 };
                let csvRow = [time];
                tableHtml += `<tr><td class="sticky left-0 bg-white z-10 font-medium py-4 pl-4 pr-3 text-sm">${time}</td>`;
                sortedDates.forEach(date => {
                    const cell = pivotData[time]?.[date];
                    if (cell) {
                        const avg = calculateAvg(cell);
                        tableHtml += `<td class="text-center py-4 px-3 text-sm" style="background-color: ${getGradientColor(avg)};">${avg.toFixed(0)}%</td>`;
                        csvRow.push(`${avg.toFixed(0)}%`);
                        Object.keys(rowTotals).forEach(key => { rowTotals[key] += cell[key]; dateTotals[date][key] += cell[key]; });
                    } else { 
                        tableHtml += `<td style="background-color: ${getGradientColor(null)};"></td>`; 
                        csvRow.push('');
                    }
                });
                const rowAvg = calculateAvg(rowTotals);
                tableHtml += `<td class="sticky right-0 bg-white z-10 font-semibold text-center py-4 pl-3 pr-4 text-sm" style="background-color: ${getGradientColor(rowAvg)};">${rowAvg.toFixed(0)}%</td></tr>`;
                csvRow.push(`${rowAvg.toFixed(0)}%`);
                csvRows.push(csvRow);
            });
            tableHtml += `</tbody><tfoot class="bg-gray-50"><tr><th class="sticky left-0 bg-gray-50 z-10 pl-4 pr-3 pt-3 text-left font-semibold text-sm">Grand Total</th>`;
            let overallTotals = { available_sum: 0, listed_sum: 0, total_sum: 0, osaxsales_sum: 0, listed_osaxsales_sum: 0, sales_sum: 0 };
            let footerCsvRow = ['Grand Total'];
            sortedDates.forEach(date => {
                const colTotals = dateTotals[date];
                const avg = calculateAvg(colTotals);
                tableHtml += `<th class="text-center px-3 pt-3 font-semibold text-sm" style="background-color: ${getGradientColor(avg)};">${avg.toFixed(0)}%</th>`;
                footerCsvRow.push(`${avg.toFixed(0)}%`);
                Object.keys(overallTotals).forEach(key => overallTotals[key] += colTotals[key]);
            });
            const overallAvg = calculateAvg(overallTotals);
            tableHtml += `<th class="sticky right-0 bg-gray-50 z-10 py-3.5 pl-3 pr-4 text-center font-semibold text-sm" style="background-color: ${getGradientColor(overallAvg)};">${overallAvg.toFixed(0)}%</th>`;
            footerCsvRow.push(`${overallAvg.toFixed(0)}%`);
            csvRows.push(footerCsvRow);
            
            tableHtml += `</tr></tfoot></table></div>`;
            outputElement.innerHTML = tableHtml;
            detailedTableCsvData = csvRows;
        }

        // --- UTILITY FUNCTIONS ---
        function downloadCsv(csvData, filename) {
            if (!csvData || csvData.length === 0) {
                alert("No data available to download.");
                return;
            }
            const csvContent = csvData.map(rowArray => {
                const rowString = rowArray.map(cell => {
                    const cellString = String(cell || '');
                    if (cellString.includes(',') || cellString.includes('"') || cellString.includes('\n')) {
                        return `"${cellString.replace(/"/g, '""')}"`;
                    }
                    return cellString;
                }).join(',');
                return rowString;
            }).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
        
        function getGradientColor(percentage) {
            if (percentage === null || isNaN(percentage)) return '#ffffff';
            if (percentage < 0) percentage = 0; if (percentage > 100) percentage = 100;
            const hue = (percentage / 100) * 120;
            return `hsl(${hue}, 90%, 85%)`;
        }

        function createSearchableMultiSelect(container, id, label, optionsSet, stateSet, changeCallback, isTimeSort = false) {
            stateSet.clear(); 
            if (id === 'timeslot_summary') {
                 new Set(['10_am', '5_pm', '10_pm']).forEach(item => stateSet.add(item));
            } else {
                 optionsSet.forEach(opt => { if(opt) stateSet.add(opt) });
            }
            
            container.innerHTML = `<div class="searchable-multiselect-container"><label for="${id}-button" class="block text-sm font-medium text-gray-700 mb-1">${label}</label><button id="${id}-button" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5 text-left flex justify-between items-center"><span class="truncate">All ${label}s</span><svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div id="${id}-options" class="searchable-multiselect-options"><input type="text" id="${id}-search" class="search-input" placeholder="Search ${label}s..."><div id="${id}-options-list" class="options-list"></div></div></div>`;
            const button = document.getElementById(`${id}-button`), optionsPanel = document.getElementById(`${id}-options`), searchInput = document.getElementById(`${id}-search`), optionsList = document.getElementById(`${id}-options-list`);
            const updateButtonText = () => {
                const btnText = button.querySelector('span'), totalOptions = new Set(Array.from(optionsSet).filter(Boolean)).size;
                if (stateSet.size === totalOptions) btnText.textContent = `All ${label}s`;
                else if (stateSet.size === 0) btnText.textContent = `None Selected`;
                else if (stateSet.size > 2) btnText.textContent = `${stateSet.size} ${label}s Selected`;
                else btnText.textContent = Array.from(stateSet).join(', ');
            };
            const renderOptions = (filter = '') => {
                optionsList.innerHTML = '';
                const totalOptions = new Set(Array.from(optionsSet).filter(Boolean)).size;
                const selectAllDiv = document.createElement('div');
                selectAllDiv.className = 'searchable-multiselect-option font-semibold';
                selectAllDiv.innerHTML = `<input type="checkbox" value="select-all" ${stateSet.size === totalOptions ? 'checked' : ''}><label class="ml-2 text-sm text-gray-800 w-full">Select All</label>`;
                selectAllDiv.querySelector('input').addEventListener('change', (e) => {
                    if (e.target.checked) optionsSet.forEach(opt => stateSet.add(opt)); else stateSet.clear();
                    renderOptions(searchInput.value); updateButtonText(); changeCallback();
                });
                optionsList.appendChild(selectAllDiv);

                const optionsArray = Array.from(optionsSet).filter(Boolean);
                const sortedOptions = isTimeSort ? optionsArray.sort((a,b)=> convertTimeTo24Hour(a) - convertTimeTo24Hour(b)) : optionsArray.sort();

                sortedOptions.forEach(opt => {
                    if (opt.toString().toLowerCase().includes(filter.toLowerCase())) {
                        const optionDiv = document.createElement('div');
                        optionDiv.className = 'searchable-multiselect-option';
                        optionDiv.innerHTML = `<input type="checkbox" value="${opt}" ${stateSet.has(opt) ? 'checked' : ''}><label class="ml-2 text-sm text-gray-800 w-full">${opt}</label>`;
                        optionDiv.querySelector('input').addEventListener('change', (e) => {
                            if (e.target.checked) stateSet.add(e.target.value); else stateSet.delete(e.target.value);
                            const allCheckbox = optionsList.querySelector('input[value="select-all"]');
                            if(allCheckbox) allCheckbox.checked = (stateSet.size === totalOptions);
                            updateButtonText(); changeCallback();
                        });
                        optionsList.appendChild(optionDiv);
                    }
                });
            };
            button.addEventListener('click', (e) => { e.stopPropagation(); document.querySelectorAll('.searchable-multiselect-options.visible').forEach(panel => { if (panel.id !== optionsPanel.id) panel.classList.remove('visible'); }); optionsPanel.classList.toggle('visible'); });
            searchInput.addEventListener('keyup', (e) => renderOptions(e.target.value));
            updateButtonText(); renderOptions();
        }

        function parseDate(dateString) {
            if (!dateString) return null;
            const ymdMatch = dateString.match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if (ymdMatch) {
                const [_, year, month, day] = ymdMatch.map(p => parseInt(p, 10));
                if (!isNaN(year) && !isNaN(month) && !isNaN(day)) return new Date(Date.UTC(year, month - 1, day));
            }
            const monthMap = {'jan': 0, 'feb': 1, 'mar': 2, 'apr': 3, 'may': 4, 'jun': 5, 'jul': 6, 'aug': 7, 'sep': 8, 'oct': 9, 'nov': 10, 'dec': 11};
            const dayMonthMatch = dateString.trim().match(/^(\d+)[a-z\s-]*(\w+)/i);
            if (dayMonthMatch) {
                const day = parseInt(dayMonthMatch[1], 10), monthStr = dayMonthMatch[2].substring(0, 3).toLowerCase();
                if (!isNaN(day) && monthMap.hasOwnProperty(monthStr)) return new Date(Date.UTC(new Date().getFullYear(), monthMap[monthStr], day));
            }
            const parts = dateString.match(/(\d+)/g); 
            if (parts && parts.length >= 2) {
                const day = parseInt(parts[0], 10), month = parseInt(parts[1], 10) - 1;
                let year = (parts.length >= 3) ? parseInt(parts[2], 10) : new Date().getFullYear();
                if (year < 100) year += 2000;
                if (!isNaN(day) && !isNaN(month) && !isNaN(year) && month >= 0 && month < 12 && day > 0 && day <= 31) return new Date(Date.UTC(year, month, day));
            }
            const parsedDate = new Date(dateString);
            if (parsedDate && !isNaN(parsedDate.getTime())) return new Date(Date.UTC(parsedDate.getUTCFullYear(), parsedDate.getUTCMonth(), parsedDate.getUTCDate()));
            return null;
        }
        
        function convertTimeTo24Hour(timeStr) {
             if (!timeStr) return 9999;
             const lower = String(timeStr).toLowerCase(); let hours = parseInt(lower.replace(/[^0-9]/g, ''), 10);
             if (lower.includes('pm') && hours !== 12) hours += 12;
             if (lower.includes('am') && hours === 12) hours = 0;
             return hours;
        }
        function showLoader(element, message) {
             element.innerHTML = `<div class="text-center"><div class="loader"></div><p class="text-gray-600 mt-2">${message}</p></div>`;
        }
        function showError(element, message) {
            element.innerHTML = `<div class="text-center text-red-600 bg-red-50 p-4 rounded-lg border border-red-200"><h3 class="font-semibold">Error</h3><p class="mt-1">${message}</p></div>`;
        }
    </script>
</body>
</html>
